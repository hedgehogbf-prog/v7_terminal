# psu/owon.py
"""
Обёртка вокруг OwonPSU из файла owon_psu_qt.py
чтобы GUI мог использовать ЛБП SPE6103.
"""

from owon_psu_qt import OwonPSU     # ← твой рабочий драйвер
import serial
import time


class OwonPSUWrapper:
    def __init__(self):
        self.device: OwonPSU | None = None
        self.port = None
        self.connected = False

    # ----------------------------------------------------------
    # ПОДКЛЮЧЕНИЕ
    # ----------------------------------------------------------

    def connect(self, port: str) -> bool:
        try:
            self.device = OwonPSU(port)
        except Exception as e:
            print("Ошибка создания драйвера:", e)
            self.device = None
            self.connected = False
            return False

        self.port = port
        self.connected = True
        return True

    # ----------------------------------------------------------
    # ОТКЛЮЧЕНИЕ
    # ----------------------------------------------------------

    def disconnect(self):
        if self.device:
            try:
                self.device.close()
            except Exception:
                pass

        self.device = None
        self.connected = False

    # ----------------------------------------------------------
    # RESET COM
    # ----------------------------------------------------------

    def reset_com(self):
        """Полный сброс COM порта через переоткрытие."""

        if not self.port:
            return False

        try:
            # Закрыть
            if self.device:
                try:
                    self.device.close()
                except:
                    pass

            time.sleep(0.3)

            # Открыть заново
            self.device = OwonPSU(self.port)
            self.connected = True
            return True

        except Exception:
            return False

    # ----------------------------------------------------------
    # ИЗМЕРЕНИЯ
    # ----------------------------------------------------------

    def read_measurements(self):
        """Возвращает (U, I) или (None, None)."""
        if not self.connected or not self.device:
            return None, None

        try:
            V = self.device.measure_voltage()
            A = self.device.measure_current()
            return V, A
        except Exception:
            return None, None

    # ----------------------------------------------------------
    # УСТАНОВКА НАПРЯЖЕНИЯ / ТОКА
    # ----------------------------------------------------------

    def set_voltage_current(self, v, a):
        if not self.connected or not self.device:
            return

        try:
            self.device.set_voltage(v)
            self.device.set_current(a)
        except Exception as e:
            print("Ошибка set_voltage_current:", e)

    # ----------------------------------------------------------
    # УПРАВЛЕНИЕ ВЫХОДОМ
    # ----------------------------------------------------------

    def set_output(self, state: bool):
        if not self.connected or not self.device:
            return

        try:
            self.device.set_output(state)
        except Exception as e:
            print("Ошибка set_output:", e)
